<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Estudiante</title>
    <link rel="stylesheet" href="styles.css">
    <script defer src="telemetry.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #ff5252;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .progress-bar {
            background: #f0f0f0;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .metric-value {
            font-weight: bold;
            color: #667eea;
        }

        .survey-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .survey-item {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .survey-item.pending {
            border-color: #ffc107;
            background: #fff8e1;
        }

        .survey-item.completed {
            border-color: #28a745;
            background: #d4edda;
        }

        .ecas-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .ecas-inputs { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .ecas-inputs label { font-size: 0.9rem; color: #555; }
        .ecas-inputs input { width: 100%; padding: 8px 10px; border: 2px solid #e1e8ed; border-radius: 10px; }
        .ecas-btn { margin-top: 10px; background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: bold; }
        .ecas-result { margin-top: 10px; font-weight: bold; color: #667eea; }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5a67d8;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: white;
            font-size: 1.2rem;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .welcome-message {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .welcome-message h2 {
            color: #667eea;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <script src="/auth.js"></script>
    <script>
        // Enforce auth and inject persistent logout bar
        if (window.SAAAuth) {
            window.SAAAuth.requireAuth({ allowedRole: 'student' });
            window.SAAAuth.injectLogoutBar();
        }
        // Telemetr√≠a: vista de p√°gina
        if (window.SAATelemetry) { window.SAATelemetry.track('page_view', { page: 'student-dashboard' }); }
    </script>
    <div class="container">
        <div class="notice">
            <strong>Nuevo:</strong> Explora tu <a href="/dss-itsu/test-ils.html" class="nav-link">Test ILS</a>, tu <a href="/dss-itsu/perfil.html" class="nav-link">Perfil + ECAS</a> y las <a href="/dss-itsu/recomendaciones.html" class="nav-link">Recomendaciones</a>.
        </div>
        <div id="loading" class="loading">Cargando dashboard...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="dashboard" style="display: none;">
            <div class="header">
                <h1>üìö Dashboard Estudiante</h1>
                <div class="user-info">
                    <span id="user-name"></span>
                </div>
            </div>

            <div class="welcome-message">
                <h2>¬°Bienvenido de nuevo!</h2>
                <p>Aqu√≠ puedes ver tu progreso y completar las encuestas pendientes.</p>
            </div>

            <div class="dashboard-grid">
                <div class="card">
                    <h3>üìä Tu Progreso</h3>
                    <div class="metric">
                        <span>Encuestas Completadas:</span>
                        <span class="metric-value" id="surveys-completed">0</span>
                    </div>
                    <div class="metric">
                        <span>Total de Encuestas:</span>
                        <span class="metric-value" id="surveys-total">0</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="completion-rate" style="width: 0%">0%</div>
                    </div>
                </div>

                <div class="card">
                    <h3>üéØ Tu Promedio</h3>
                    <div class="metric">
                        <span>Promedio General:</span>
                        <span class="metric-value" id="average-grade">0.0</span>
                    </div>
                    <div class="metric">
                        <span>Semestre Actual:</span>
                        <span class="metric-value" id="current-semester">-</span>
                    </div>
                    <div class="metric">
                        <span>Carrera:</span>
                        <span class="metric-value" id="career">-</span>
                    </div>
                </div>

                <div class="card">
                    <h3>üìà Semanas de Progreso</h3>
                    <div id="weekly-progress">
                        <p>Cargando progreso semanal...</p>
                    </div>
                </div>
                <div class="ecas-card">
                    <h3>üß† ECAS - Predicci√≥n r√°pida de riesgo</h3>
                    <p style="color:#666;margin-bottom:8px;">Para explicaci√≥n detallada y factores, visita <a href="/dss-itsu/perfil.html" style="color:#2b6cb0;">Perfil + ECAS</a>.</p>
                    <div class="ecas-inputs">
                        <div>
                            <label>Nota 1</label>
                            <input type="number" id="ecasNota1" min="0" max="10" step="0.1" placeholder="ej. 8.0">
                        </div>
                        <div>
                            <label>Nota 2</label>
                            <input type="number" id="ecasNota2" min="0" max="10" step="0.1" placeholder="ej. 8.5">
                        </div>
                        <div>
                            <label>Asistencia %</label>
                            <input type="number" id="ecasAsis" min="0" max="100" step="1" placeholder="ej. 85">
                        </div>
                    </div>
                    <button class="ecas-btn" onclick="predictRiskQuick()">Predict my risk</button>
                    <div id="ecasResult" class="ecas-result"></div>
                </div>
            </div>

            <div class="survey-section">
                <h3>üìù Encuestas Pendientes</h3>
                <div id="pending-surveys">
                    <p>Cargando encuestas...</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                <div class="info-box" style="background:#f0f4ff;border:1px solid #e0e7ff;border-radius:10px;padding:12px 16px;margin-top:8px;text-align:center;color:#4a5568;">
                    La p√°gina de encuestas fue deshabilitada.
                </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let studentProfile = null;

        async function loadDashboard() {
            try {
                // Obtener token del almacenamiento local
                const token = localStorage.getItem('authToken');
                const userRole = localStorage.getItem('userRole');
                
                if (!token || userRole !== 'student') {
                    window.location.href = '/login.html';
                    return;
                }

                // Configurar usuario actual desde localStorage
                currentUser = {
                    firstName: localStorage.getItem('userFirstName') || 'Estudiante',
                    lastName: localStorage.getItem('userLastName') || '',
                    role: userRole
                };

                // Cargar perfil del estudiante
                const profileResponse = await fetch('/api/student/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (profileResponse.ok) {
                    const profileData = await profileResponse.json();
                    if (profileData.success) {
                        studentProfile = profileData.data;
                        updateDashboard();
                    } else {
                        throw new Error(profileData.message || 'Error al cargar perfil');
                    }
                } else {
                    throw new Error('Error al cargar perfil');
                }

                // Cargar encuestas pendientes
                await loadPendingSurveys();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';

                try {
                    const last = localStorage.getItem('ecasLastPrediction');
                    if (last) {
                        const parsed = JSON.parse(last);
                        document.getElementById('ecasResult').textContent = `√öltima predicci√≥n: ${parsed.pct}% (N1 ${parsed.nota1}, N2 ${parsed.nota2}, Asis ${parsed.asistencia}%)`;
                        if (document.getElementById('ecasNota1')) document.getElementById('ecasNota1').value = parsed.nota1;
                        if (document.getElementById('ecasNota2')) document.getElementById('ecasNota2').value = parsed.nota2;
                        if (document.getElementById('ecasAsis')) document.getElementById('ecasAsis').value = parsed.asistencia;
                    }
                } catch {}

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('error').textContent = 'Error al cargar el dashboard: ' + error.message;
                document.getElementById('error').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        }

        function updateDashboard() {
            if (!studentProfile) return;

            // Actualizar informaci√≥n del usuario
            document.getElementById('user-name').textContent = 
                `${currentUser.firstName} ${currentUser.lastName}`;

            // Actualizar m√©tricas
            document.getElementById('surveys-completed').textContent = studentProfile.surveysCompleted || 0;
            document.getElementById('surveys-total').textContent = studentProfile.surveysTotal || 0;
            
            const completionRate = parseFloat(studentProfile.completionRate || '0');
            document.getElementById('completion-rate').style.width = completionRate + '%';
            document.getElementById('completion-rate').textContent = completionRate.toFixed(1) + '%';

            document.getElementById('average-grade').textContent = studentProfile.average || '0.0';
            document.getElementById('current-semester').textContent = studentProfile.semester || '-';
            document.getElementById('career').textContent = studentProfile.career || '-';

            // Actualizar progreso semanal
            updateWeeklyProgress();
        }

        function updateWeeklyProgress() {
            const weeklyProgress = document.getElementById('weekly-progress');
            
            if (studentProfile.weeklyProgress && studentProfile.weeklyProgress.length > 0) {
                const recentWeeks = studentProfile.weeklyProgress.slice(-4); // √öltimas 4 semanas
                
                weeklyProgress.innerHTML = recentWeeks.map(week => `
                    <div class="metric">
                        <span>Semana ${week.weekNumber}:</span>
                        <span class="metric-value">${week.tasksCompleted}/${week.tasksTotal} tareas</span>
                    </div>
                `).join('');
            } else {
                weeklyProgress.innerHTML = '<p>No hay datos de progreso semanal disponibles.</p>';
            }
        }

        async function loadPendingSurveys() {
            const fallback = [
                { question: 'Encuesta de Tecnolog√≠a Educativa', category: 'Tecnolog√≠a' },
                { question: 'Evaluaci√≥n de Docentes', category: 'Desempe√±o' }
            ];
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/student/surveys/pending', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const pendingSurveys = await response.json();
                    displayPendingSurveys(Array.isArray(pendingSurveys) && pendingSurveys.length ? pendingSurveys : fallback);
                } else {
                    displayPendingSurveys(fallback);
                }
            } catch (error) {
                console.error('Error al cargar encuestas pendientes:', error);
                displayPendingSurveys(fallback);
            }
        }

        function displayPendingSurveys(surveys) {
            const container = document.getElementById('pending-surveys');
            
            if (surveys.length === 0) {
                container.innerHTML = '<p>¬°Felicidades! Has completado todas las encuestas.</p>';
            } else {
                container.innerHTML = surveys.map(survey => `
                    <div class="survey-item pending">
                        <div>
                            <strong>${survey.question}</strong>
                            <br><small>Categor√≠a: ${survey.category}</small>
                        </div>
                        <span class="metric-value">Pendiente</span>
                    </div>
                `).join('');
            }
        }

        // logout handled by global SAAAuth.logout via barra superior

        // Cargar dashboard al iniciar
        loadDashboard();

        // ECAS predicci√≥n r√°pida
        async function predictRiskQuick() {
            try {
                const nota1 = parseFloat(document.getElementById('ecasNota1')?.value || studentProfile?.average || 8);
                const nota2 = parseFloat(document.getElementById('ecasNota2')?.value || (studentProfile?.average ? (studentProfile.average - 0.3) : 7.8));
                const asistencia = parseFloat(document.getElementById('ecasAsis')?.value || 85);
                const modelResp = await fetch('dss-itsu/data/model.json'); // relativo para GitHub Pages
                const model = await modelResp.json();
                const coefs = model?.coefs || { visual: 0.0, activo: 0.0, nota1: -0.3, nota2: -0.35, asistencia: -0.8 };
                const intercept = typeof model?.intercept === 'number' ? model.intercept : -2.0;
                const visual = 0.0;
                const activo = 0.0;
                const logit = intercept + coefs.visual * visual + coefs.activo * activo + coefs.nota1 * nota1 + coefs.nota2 * nota2 + coefs.asistencia * asistencia;
                const prob = 1 / (1 + Math.exp(-logit));
                const pct = (prob * 100).toFixed(1);
                document.getElementById('ecasResult').textContent = `Riesgo estimado de deserci√≥n: ${pct}%`;
                try {
                    localStorage.setItem('ecasLastPrediction', JSON.stringify({ pct, nota1, nota2, asistencia, at: Date.now() }));
                } catch {}
            } catch (e) {
                document.getElementById('ecasResult').textContent = 'Error al calcular riesgo.';
                console.error(e);
            }
        }
    </script>
</body>
</html>
